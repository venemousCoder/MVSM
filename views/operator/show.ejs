<div class="container py-4">
    <div class="mb-4">
        <a href="/operator/queue" class="text-decoration-none"><i class="fas fa-arrow-left me-2"></i> Back to Queue</a>
    </div>

    <div class="d-flex justify-content-between flex-wrap align-items-center mb-4">
        <h1 class="h2 mb-0">Order #<%= order._id.toString().slice(-6).toUpperCase() %></h1>
        <div class="mt-2 mt-md-0">
             <% 
                let statusClass = 'bg-secondary';
                if(order.status === 'completed') statusClass = 'bg-success';
                if(order.status === 'processing') statusClass = 'bg-info text-dark';
                if(order.status === 'cancelled') statusClass = 'bg-danger';
                if(order.status === 'pending') statusClass = 'bg-warning text-dark';
            %>
            <span class="badge <%= statusClass %> fs-6 px-3 py-2 rounded-pill text-uppercase"><%= order.status %></span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <!-- Items -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Details</h5>
                </div>
                <div class="list-group list-group-flush">
                    <% order.items.forEach(item => { %>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                    <i class="fas fa-tools text-secondary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0"><%= item.name %></h6>
                                    <small class="text-muted">
                                        <% if (item.service) { %>
                                            <%= item.service.name %> (<%= item.service.duration %> mins)
                                        <% } %>
                                    </small>
                                </div>
                            </div>
                            <span class="fw-bold">$<%= (item.price * item.quantity).toFixed(2) %></span>
                        </div>
                    <% }) %>
                    <div class="list-group-item d-flex justify-content-between align-items-center fw-bold bg-light">
                        <span>Total</span>
                        <span>$<%= order.totalAmount.toFixed(2) %></span>
                    </div>
                </div>
            </div>

            <!-- Order History / Timeline -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Activity Log</h5>
                </div>
                <div class="card-body">
                    <ul class="timeline list-unstyled">
                        <% order.history.sort((a,b) => b.createdAt - a.createdAt).forEach(event => { %>
                            <li class="mb-3 position-relative ps-4 border-start border-2 ms-2">
                                <span class="position-absolute top-0 start-0 translate-middle bg-white p-1" style="left: -1px;">
                                    <i class="fas fa-circle text-primary small"></i>
                                </span>
                                <div class="ms-2">
                                    <p class="mb-0 fw-bold text-capitalize"><%= event.action.replace('_', ' ') %></p>
                                    <p class="mb-0 small text-muted"><%= event.note %></p>
                                    <small class="text-secondary"><%= new Date(event.createdAt).toLocaleString() %></small>
                                </div>
                            </li>
                        <% }) %>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Customer Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Customer</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
                            <i class="fas fa-user text-secondary"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">
                                <%= order.customer ? order.customer.name : order.customerName || 'Guest' %>
                                <% if (order.customer) { %>
                                    <% getUserBadges(order.customer).forEach(badge => { %>
                                        <span class="badge bg-<%= badge.color %> ms-1" style="font-size: 0.7em;"><%= badge.label %></span>
                                    <% }) %>
                                <% } %>
                            </h6>
                            <small class="text-muted">Customer</small>
                        </div>
                    </div>
                    <hr>
                    <p class="mb-2"><i class="fas fa-envelope me-2 text-muted"></i> <%= order.customer ? order.customer.email : order.customerEmail || 'N/A' %></p>
                    <p class="mb-0"><i class="fas fa-phone me-2 text-muted"></i> <%= order.customer ? order.customer.phone : 'N/A' %></p>
                </div>
            </div>

            <!-- Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <% if (order.status === 'pending') { %>
                        <form action="/operator/queue/<%= order._id %>/status" method="POST" class="d-grid gap-2">
                            <input type="hidden" name="status" value="processing">
                            <button type="submit" class="btn btn-primary">Start Processing</button>
                        </form>
                    <% } else if (order.status === 'processing') { %>
                        <form action="/operator/queue/<%= order._id %>/status" method="POST" class="d-grid gap-2">
                            <input type="hidden" name="status" value="completed">
                            <button type="submit" class="btn btn-success">Mark Completed</button>
                        </form>
                    <% } else if (order.status === 'completed') { %>
                        <div class="alert alert-success mb-0 text-center">
                            <i class="fas fa-check-circle me-2"></i> Completed
                            <br>
                            <small class="text-muted"><%= order.completedAt ? new Date(order.completedAt).toLocaleString() : '' %></small>
                        </div>
                    <% } else { %>
                        <p class="text-center text-muted mb-0">No actions available.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>
