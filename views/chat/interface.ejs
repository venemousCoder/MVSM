<div class="container py-4" style="max-width: 600px;">
    <!-- Header -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body p-3">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-robot fa-lg"></i>
                    </div>
                </div>
                <div>
                    <h6 class="mb-0 fw-bold">Service Request</h6>
                    <small class="text-muted">
                        <%= service.business.name %> 
                        <% if(operator) { %> â€¢ Operator: <%= operator.user.name %> <% } %>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <div class="card shadow border-0" style="height: 600px; display: flex; flex-direction: column;">
        <div id="chat-messages" class="card-body overflow-auto flex-grow-1 p-4" style="background-color: #f8f9fa;">
            <!-- Messages will appear here -->
        </div>
        
        <div class="card-footer bg-white p-3 border-top">
            <div id="input-area">
                <!-- Dynamic Input Controls -->
                <p class="text-muted small text-center mb-0">Please select an option above...</p>
            </div>
        </div>
    </div>
</div>

<script>
    const script = <%- JSON.stringify(script) %>;
    const serviceId = '<%= service._id %>';
    const operatorId = '<%= operator ? operator._id : "" %>';
    let currentNodeId = script.startNodeId;
    let chatHistory = []; // To store transcript
    let summary = [];
    let answers = [];

    const messagesContainer = document.getElementById('chat-messages');
    const inputArea = document.getElementById('input-area');

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `d-flex mb-3 ${sender === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `p-3 rounded-3 shadow-sm ${sender === 'user' ? 'bg-primary text-white' : 'bg-white text-dark border'}`;
        bubble.style.maxWidth = '80%';
        bubble.innerText = text;
        
        div.appendChild(bubble);
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        chatHistory.push({ sender, text });
    }

    function renderNode(nodeId) {
        const node = script.nodes[nodeId];
        if (!node) return;

        // Bot speaks
        setTimeout(() => {
            addMessage(node.text, 'bot');
            
            // Render Inputs
            inputArea.innerHTML = '';
            
            if (node.isFinal) {
                 const btn = document.createElement('button');
                 btn.className = 'btn btn-success w-100 fw-bold';
                 btn.innerText = 'Add to Cart & Checkout';
                 btn.onclick = finishChat;
                 inputArea.appendChild(btn);
                 return;
            }

            if (node.options) {
                const btnGroup = document.createElement('div');
                btnGroup.className = 'd-grid gap-2';
                
                node.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline-primary text-start';
                    btn.innerText = opt.label;
                    btn.onclick = () => handleOption(opt, node);
                    btnGroup.appendChild(btn);
                });
                inputArea.appendChild(btnGroup);
            } else if (node.inputType === 'number') {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'form-control';
                input.placeholder = 'Enter quantity...';
                
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.innerText = 'Send';
                btn.onclick = () => handleInput(input.value, node);
                
                inputGroup.appendChild(input);
                inputGroup.appendChild(btn);
                inputArea.appendChild(inputGroup);
                input.focus();
            } else if (node.inputType === 'file') {
                 const inputGroup = document.createElement('div');
                 
                 const input = document.createElement('input');
                 input.type = 'file';
                 input.className = 'form-control mb-2';
                 
                 const btn = document.createElement('button');
                 btn.className = 'btn btn-primary w-100';
                 btn.innerText = 'Upload & Continue';
                 btn.onclick = () => {
                     // Mock upload
                     if(input.files.length > 0) {
                         handleInput(`[File Uploaded: ${input.files[0].name}]`, node);
                     } else {
                         alert('Please select a file');
                     }
                 };
                 
                 inputGroup.appendChild(input);
                 inputGroup.appendChild(btn);
                 inputArea.appendChild(inputGroup);
            }

        }, 500);
    }

    function handleOption(option, node) {
        addMessage(option.label, 'user');
        summary.push(option.value);
        answers.push({
            question: node.text,
            answer: option.value,
            type: 'option'
        });
        currentNodeId = option.next;
        renderNode(currentNodeId);
    }

    function handleInput(value, node) {
        if(!value) return;
        addMessage(value, 'user');
        summary.push(value);
        answers.push({
            question: node.text,
            answer: value,
            type: node.inputType || 'text'
        });
        currentNodeId = node.next;
        renderNode(currentNodeId);
    }

    async function finishChat() {
        // Post data to server
        const response = await fetch(`/services/${serviceId}/chat/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                operatorId,
                transcript: chatHistory,
                summary: summary.join(', '),
                answers: answers
            })
        });
        
        const data = await response.json();
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert('Error processing request');
        }
    }

    // Start Chat
    renderNode(currentNodeId);

</script>
